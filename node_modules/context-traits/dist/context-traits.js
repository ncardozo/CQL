/* Context Traits v0.0.1
   https://github.com/tagae/context-traits
   Copyright © 2012—2015 © 2012—2015 UCLouvain
   Licensed under Apache Licence, Version 2.0 */
(function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m={}.hasOwnProperty;u=function(e,t,n){var r,i,s,o;n==null&&(n=[]),i=this[e];if(i==null){if(typeof require!="undefined"&&require!==null){i=require(t);for(s=0,o=n.length;s<o;s++)r=n[s],i=i[r];return this[e]=i}throw new Error("Required object '"+e+"' of library '"+t+"' not found")}},u("_","underscore"),u("Trait","traits",["Trait"]),(v=(d=Function.prototype).inheritFrom)==null&&(d.inheritFrom=function(e){return this.prototype=new e,this}),Array.prototype.top=function(){return this[this.length-1]},n=function(e){var t;return this.activationCount=0,this.adaptations=[],this.manager=((t=o.Default)!=null?t.manager:void 0)||new r,e!=null&&(this.name=function(){return e}),this},t=function(e,t,n){return this.context=e,this.object=t,this.trait=n,this},r=function(){return this.adaptations=[],this.invocations=[],this.policy=new e,this.totalActivations=0,this},s=function(){return this},_.extend(n.prototype,{activate:function(){return++this.activationCount===1&&(this.activationStamp=++this.manager.totalActivations,this.activateAdaptations()),this},deactivate:function(){if(this.activationCount>0)return--this.activationCount===0&&(this.deactivateAdaptations(),delete this.activationStamp),this;throw new Error("Cannot deactivate inactive context")},isActive:function(){return this.activationCount>0}}),l={compose:function(e,t){var n,r,i;i=Trait.compose(e.trait,t);for(n in i){if(!m.call(i,n))continue;r=i[n];if(r.conflict)throw new Error("Property '"+n+"' already adapted for "+e.object+" in "+e.context)}return i},preserve:function(e,t){return Trait.override(e.trait,t)},override:function(e,t){return Trait.override(t,e.trait)},prevent:function(e,t){throw new Error(e.object+" already adapted in "+e.context)}},_.extend(n.prototype,{adapt:function(e,t){if(e instanceof Object)return o.Default.addAdaptation(e,Trait(e),l.preserve),this.addAdaptation(e,t,l.compose);throw new Error("Values of type "+typeof e+" cannot be adapted.")},addAdaptation:function(e,n,r){var i;return n=h(n,e),i=this.adaptationFor(e),i?(i.trait=r(i,n),this.isActive()&&this.manager.updateBehaviorOf(e)):(n=Trait.compose(n,p.Extensible),i=new t(this,e,n),this.adaptations.push(i),this.isActive()&&this.manager.deployAdaptation(i)),this},adaptationFor:function(e){return _.find(this.adaptations,function(t){return t.object===e})},activateAdaptations:function(){var e,t,n,r,i;r=this.adaptations,i=[];for(t=0,n=r.length;t<n;t++)e=r[t],i.push(this.manager.deployAdaptation(e));return i},deactivateAdaptations:function(){var e,t,n,r,i;r=this.adaptations,i=[];for(t=0,n=r.length;t<n;t++)e=r[t],i.push(this.manager.withdrawAdaptation(e));return i}}),_.extend(r.prototype,{deployAdaptation:function(e){return this.adaptations.push(e),this.updateBehaviorOf(e.object)},withdrawAdaptation:function(e){var t;t=this.adaptations.indexOf(e);if(t===-1)throw new Error("Attempt to withdraw unmanaged adaptation");return this.adaptations.splice(t,1),this.updateBehaviorOf(e.object)},updateBehaviorOf:function(e){return this.adaptationChainFor(e)[0].deploy(),this},adaptationChainFor:function(e){var t;t=_.filter(this.adaptations,function(t){return t.object===e});if(t.length===0)throw new Error("No adaptations found for "+e);return this.policy.order(t)}}),_.extend(t.prototype,{deploy:function(){return _.extend(this.object,Object.create({},this.trait))},toString:function(){return"Adaptation for "+this.object+" in "+this.context},equivalent:function(e){return this.context===e.context&&this.object===e.object&&Trait.eqv(this.trait,e.trait)}}),p={},p.Extensible=Trait({proceed:function(){var e,t,n,r,i,s,u,a,f;i=o.Default.manager,r=i.invocations;if(r.length===0)throw new Error("Proceed must be called from an adaptation");f=r.top(),a=f[0],s=f[1],u=f[2],t=f[3],t=arguments.length===0?t:arguments,e=i.orderedMethods(a,u),n=e.indexOf(s);if(n===-1)throw new Error("Cannot proceed from an inactive adaptation");if(n+1===e.length)throw new Error("Cannot proceed further");return e[n+1].apply(this,t)}}),c=function(e,t,n){var r;return r=function(){var i;i=o.Default.manager.invocations,i.push([e,r,t,arguments]);try{return n.apply(this,arguments)}finally{i.pop()}},r},h=function(e,t){var n,r,i;r=Trait.compose(e);for(n in r){if(!m.call(r,n))continue;i=r[n],_.isFunction(i.value)&&(i.value=c(t,n,i.value))}return r},_.extend(r.prototype,{orderedMethods:function(e,t){var n,r,i,s,o;r=this.adaptationChainFor(e),o=[];for(i=0,s=r.length;i<s;i++)n=r[i],o.push(n.trait[t].value);return o}}),_.extend(s.prototype,{order:function(e){var t;return t=this,e.sort(function(e,n){if(e.object!==n.object)throw new Error("Refusing to order adaptations of different objects");return t.compare(e,n)})},compare:function(e,t){throw new Error("There is no criterium to order adaptations")},toString:function(){return this.name()+" policy"},name:function(){return"anonymous"}}),e=function(){return s.call(this),this},e.inheritFrom(s),_.extend(e.prototype,{compare:function(e,t){return e.context.activationAge()-t.context.activationAge()},name:function(){return"activation age"}}),_.extend(n.prototype,{activationAge:function(){return this.manager.totalActivations-this.activationStamp}}),i=function(e,t){t==null&&(t=null);if(!e)throw new Error("Namespaces must have a name");return this.name=e,this.parent=t,t||(this.home=f()),this},_.extend(i.prototype,{root:function(){return this.parent!=null?this.parent.root():this},path:function(){var e;return this.parent!=null?(e=this.parent.path(),e.push(this.name),e):[this.name]},normalizePath:function(e){if(_.isString(e))return e=e.split(".");if(_.isArray(e))return e;throw new Error("Invalid path specification")},ensure:function(e){var t,n,r,s;e=this.normalizePath(e),n=this;for(r=0,s=e.length;r<s;r++)t=e[r],n[t]==null&&(n[t]=new i(t,n)),n=n[t];return n},add:function(e){return _.extend(this,e)},load:function(e,t){var n,r;r=t.success||function(){},n=t.failure||function(){},e=this.normalizePath(e);if(typeof document!="undefined"&&document!==null)return this.loadInBrowser(e,r,n);throw new Error("Loading of context modules not supported in current JavaScript platform.")},loadInBrowser:function(e,t,n){var r,i;if(typeof $=="undefined"||$===null)throw new Error("Context module loading depends on jQuery");return r=this,i=r.root().home+r.path().concat(e).join("/")+".js",$.ajax({url:i,dataType:"text",success:function(s,o,u){var a,f;try{return window.hasOwnProperty("exports")&&(f=window.exports),window.exports={},$.globalEval(s),a=r.ensure(e),a.add(window.exports),f!=null?window.exports=f:delete window.exports,console.log("Loaded "+i),t()}catch(l){return n(l)}},error:function(e,t,r){return console.log("Failed to load "+i+" ("+t+"): "+r),n(r)}})}}),_.extend(n.prototype,{path:function(e){var t,n,r,s,u,a,f;e==null&&(e=o),n=_.keys(e),u=_.values(e),t=u.indexOf(this);if(t!==-1)return[n[t]];for(t=a=0,f=u.length;a<f;t=++a){s=u[t];if(s instanceof i&&n[t]!=="parent"){r=this.path(s);if(r)return r.unshift(n[t]),r}}return!1},name:function(){var e;return e=this.path(),e?e.join("."):"anonymous"},toString:function(){return this.name()+" context"}}),f=function(){var e,t,n,r,i,s;try{throw new Error}catch(o){n=o.stack||o.stacktrace;if(!n)throw o.sourceURL?new Error("TODO: error.sourceURL not supported yet."):new Error("Could not determine script home directory.");s=n.split("\n");for(r=0,i=s.length;r<i;r++){e=s[r],t=/(http|file):\/\/[^/]*(\/.*\/)[^/]*\.js/.exec(e);if(t!=null)return t[2]}}return null},o=new i("contexts"),o.Default=new n("default"),o.Default.activate();if(typeof a=="undefined"||a===null)a=this;a.Context=n,a.Namespace=i,a.Policy=s,a.Trait=Trait,a.contexts=o}).call(this);